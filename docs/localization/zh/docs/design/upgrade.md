### **概述**

任何投入生产的软件系统都会有版本变更、升级新功能的情况，区块链系统也不例外。但是区块链系统的升级会更复杂一些，会面临更多问题。

### **问题**

*   升级时服务是否可用？
*   如何实现向下兼容？
*   如何确保各节点都升级到同一版本了？
*   当部分节点升级到了新版本而部分节点还未升级时怎么处理？
*   各节点升级后，新加入的节点需要注意什么？
*   升级有什么策略或者约束？
*   升级会不会带来分叉的问题？

#### **升级时服务是否可用？**

!!! tip "提示" 常见的业务系统升级一般都是需要暂停服务的，也有些大型系统已经做到了不影响服务，但是对系统整个运维部署提出了较高的要求，而区块链系统天然的解决了这个问题。
     

1.  升级时逐个节点升级到新的版本即可。
2.  只有全部节点版本号一致时，新版本的交易才能执行成功。


#### **如何实现向下兼容？**

!!! tip "提示" 新版本需要考虑对上游业务接口的影响
     

1.  对上游业务的接口都增加版本号识别标识，用于区分每个接口的版本，如有变更时，需要更换该标识即可。例如：``` /v4/** ```。
2.  对提交到链的交易数据增加版本号标识，Stacs.Native区块链系统会基于数据的版本来确定具体的代码处理逻辑。


#### **如何确保各节点都升级到同一版本了？**

!!! tip "提示" 如果各节点版本不一致，会导致低版本节点执行新版本交易失败，最终造成各节点处理结果不一致。
     

1.  由master定时去检测各节点版本号，如果版本号不一致，则各个节点保持原有版本来处理交易。
2.  由master发起版本号升级的交易，各节点验证后统一变更为新的版本号。


#### **当部分节点升级到了新版本而部分节点还未升级时怎么处理？**

!!! tip "提示" 如果各节点版本不一致，会导致低版本节点执行新版本交易失败，最终造成各节点处理结果不一致。
     

1.  若部分节点是新版本时，由它下发的新版本交易会被各节点执行失败。
2.  各节点执行依据是链的统一版本号，而不是各节点版本号。


#### **各节点升级后，新加入的节点需要注意什么？**

!!! tip "提示" 对于节点加入的那个节点的版本号的要求，若比链上版本号低的话，它执行高版本交易就会失败。
     

1.  新节点版本号必须大于等于当前区块链的版本号。


#### **升级有什么策略或者约束？**

1.  运维端只需要更换jar包重启服务即可，集群中会有master统一处理升级功能。
2.  master在收集到全节点一致的版本号后下发升级交易。
3.  并非一个节点换了新版本后就可以立即使用新版本的交易了。


#### **升级会不会带来分叉的问题？**
!!! tip "提示" 分叉对于区块链来讲是有可能出现的，需要建立一套机制确保各个节点版本一致才能不会出现分叉。

1.  由master节点决定是否升级，而前提条件是各节点的版本号是一致的，当条件满足时，由master节点组装升级交易下发到各节点，这样各节点的版本就会一致，就不会产生分叉问题。











